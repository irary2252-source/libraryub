<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>è¯»è€…æœåŠ¡ä¸­å¿ƒ - å›¾ä¹¦é¦†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 56px; font-family: "Microsoft YaHei", sans-serif; }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar { position: fixed; top: 0; width: 100%; z-index: 1030; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar { position: fixed; top: 56px; bottom: 0; left: 0; z-index: 1000; padding: 20px 0; background-color: #ffffff; width: 240px; border-right: 1px solid #dee2e6; }
        .sidebar .nav-link { color: #495057; padding: 12px 20px; font-weight: 500; border-radius: 0; border-left: 4px solid transparent; transition: all 0.2s; }
        .sidebar .nav-link:hover { background-color: #f8f9fa; color: #007bff; }
        .sidebar .nav-link.active { color: #007bff; background-color: #e9ecef; border-left-color: #007bff; }
        .sidebar i { width: 25px; text-align: center; margin-right: 10px; }

        /* å³ä¾§å†…å®¹åŒºåŸŸ */
        .content-area { margin-left: 240px; padding: 30px; }
        .section-card { border: none; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.05); background: white; margin-bottom: 20px; }
        .card-header { background-color: white; border-bottom: 1px solid #f0f0f0; padding: 20px; border-radius: 10px 10px 0 0 !important; }
        .card-title { margin: 0; font-weight: bold; color: #333; font-size: 1.1rem; }

        /* è¡¨æ ¼ä¸æ ‡ç­¾ */
        .table-hover tbody tr:hover { background-color: #f8f9fa; }
        .category-tags .btn { margin-right: 8px; margin-bottom: 8px; border-radius: 20px; padding: 5px 15px; font-size: 0.85rem; }
        .summary-box { background-color: #f8f9fa; border-left: 4px solid #198754; padding: 15px; color: #666; font-size: 0.95rem; line-height: 1.6; }

        /* çŠ¶æ€å¾½ç«  */
        .status-badge { font-size: 0.85rem; padding: 6px 12px; border-radius: 20px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container-fluid">
        <a class="navbar-brand ms-3" href="#"><i class="fas fa-book-reader me-2"></i> å›¾ä¹¦é¦†è¯»è€…è‡ªåŠ©ç³»ç»Ÿ</a>
        <div class="d-flex align-items-center me-4">
            <span class="text-white me-3"><i class="fas fa-id-card me-1"></i> å¡å·: <strong id="topCardId" class="text-warning">...</strong></span>
            <button onclick="logout()" class="btn btn-outline-light btn-sm"><i class="fas fa-sign-out-alt"></i> é€€å‡º</button>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <nav id="sidebar" class="sidebar">
            <ul class="nav flex-column nav-pills" id="readerTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="pill" href="#tab-search"><i class="fas fa-search"></i> é¦†è—å›¾ä¹¦æŸ¥è¯¢</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#tab-bookshelf" onclick="loadMyBooks()"><i class="fas fa-book"></i> æˆ‘çš„ä¹¦æ¶ (åœ¨å€Ÿ)</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#tab-borrow-fine" onclick="loadMyFines()"><i class="fas fa-barcode"></i> è‡ªåŠ©å€Ÿä¹¦ä¸ç½šæ¬¾</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#tab-recommend" onclick="loadMyRecommends()"><i class="fas fa-hand-holding-heart"></i> å›¾ä¹¦èè´­</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#tab-profile"><i class="fas fa-user-cog"></i> ä¸ªäººä¸­å¿ƒ</a>
                </li>
            </ul>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 content-area">
            <div class="tab-content">

                <div class="tab-pane fade show active" id="tab-search">
                    <div class="card section-card">
                        <div class="card-header"><h5 class="card-title text-primary"><i class="fas fa-search me-2"></i>é¦†è—æ£€ç´¢</h5></div>
                        <div class="card-body">
                            <div class="input-group mb-4">
                                <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="è¾“å…¥ä¹¦åã€ä½œè€…ã€ISBNæˆ–åˆ†ç±»...">
                                <button class="btn btn-primary px-4" onclick="searchBooks()"><i class="fas fa-search"></i> æœç´¢</button>
                                <button class="btn btn-outline-secondary px-4" onclick="loadBooks()"><i class="fas fa-sync-alt"></i> é‡ç½®</button>
                            </div>
                            <div class="category-tags mb-3">
                                <span class="text-muted me-2"><i class="fas fa-filter"></i> å¿«é€Ÿç­›é€‰:</span>
                                <button class="btn btn-outline-secondary" onclick="filterByCategory('')">å…¨éƒ¨</button>
                                <button class="btn btn-outline-info" onclick="filterByCategory('è®¡ç®—æœº')">ğŸ’» è®¡ç®—æœº</button>
                                <button class="btn btn-outline-warning" onclick="filterByCategory('å†å²')">ğŸ“œ å†å²</button>
                                <button class="btn btn-outline-success" onclick="filterByCategory('é‡‘è')">ğŸ’° é‡‘è</button>
                                <button class="btn btn-outline-danger" onclick="filterByCategory('è‹±è¯­')">ğŸ…°ï¸ è‹±è¯­</button>
                                <button class="btn btn-outline-primary" onclick="filterByCategory('æ•°å­¦')">ğŸ“ æ•°å­¦</button>
                                <button class="btn btn-outline-dark" onclick="filterByCategory('æ–‡å­¦')">ğŸ“– æ–‡å­¦</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle" id="bookTable">
                                    <thead class="table-light"><tr><th>ISBN</th><th>ä¹¦å</th><th>åˆ†ç±»</th><th>ä½œè€…</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-bookshelf">
                    <div class="card section-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title text-success"><i class="fas fa-book me-2"></i>æˆ‘çš„å½“å‰å€Ÿé˜…</h5>
                            <button onclick="loadMyBooks()" class="btn btn-sm btn-outline-success"><i class="fas fa-sync"></i> åˆ·æ–°åˆ—è¡¨</button>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped align-middle" id="borrowTable">
                                <thead class="table-light"><tr><th>ä¹¦å</th><th>å€Ÿé˜…æ—¶é—´</th><th>åº”è¿˜æ—¥æœŸ</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                                <tbody></tbody>
                            </table>
                            <div id="emptyBookshelf" class="text-center text-muted py-5" style="display:none;">
                                <i class="fas fa-book-open fa-3x mb-3"></i><br>æš‚æ— å€Ÿé˜…è®°å½•ï¼Œå¿«å»å€Ÿå‡ æœ¬ä¹¦å§ï¼
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-borrow-fine">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card section-card h-100">
                                <div class="card-header"><h5 class="card-title text-primary"><i class="fas fa-barcode me-2"></i>è‡ªåŠ©å€Ÿä¹¦</h5></div>
                                <div class="card-body text-center py-5">
                                    <p class="text-muted mb-4">è¯·å°†å…‰æ ‡ç½®äºä¸‹æ–¹è¾“å…¥æ¡†ï¼Œæ‰«æå›¾ä¹¦æ¡å½¢ç æˆ–æ‰‹åŠ¨è¾“å…¥ ISBN</p>
                                    <div class="input-group input-group-lg mb-3">
                                        <span class="input-group-text"><i class="fas fa-keyboard"></i></span>
                                        <input type="text" id="borrowIsbn" class="form-control" placeholder="ISBN (ä¾‹å¦‚: 978-001)">
                                    </div>
                                    <button onclick="borrowBook()" class="btn btn-primary w-100 btn-lg mb-3">ç¡®è®¤å€Ÿé˜…</button>
                                    <div id="borrowResult" class="fw-bold mt-3"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card section-card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="card-title text-danger"><i class="fas fa-exclamation-circle me-2"></i>å¾…ç¼´ç½šæ¬¾</h5>
                                    <button onclick="loadMyFines()" class="btn btn-sm btn-outline-danger"><i class="fas fa-sync"></i> åˆ·æ–°</button>
                                </div>
                                <div class="card-body">
                                    <table class="table align-middle" id="fineTable">
                                        <thead><tr><th>å›¾ä¹¦</th><th>é‡‘é¢</th><th>æ“ä½œ</th></tr></thead>
                                        <tbody></tbody>
                                    </table>
                                    <div id="emptyFines" class="text-center text-success py-4" style="display:none;">
                                        <i class="fas fa-check-circle fa-2x mb-2"></i><br>ä¿¡ç”¨è‰¯å¥½ï¼Œæ— å¾…ç¼´ç½šæ¬¾
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-recommend">
                    <div class="card section-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title text-info"><i class="fas fa-list-alt me-2"></i>æˆ‘çš„èè´­è®°å½•</h5>
                            <button class="btn btn-info text-white" data-bs-toggle="modal" data-bs-target="#recommendModal"><i class="fas fa-plus me-1"></i> æˆ‘è¦èè´­</button>
                        </div>
                        <div class="card-body">
                            <table class="table table-hover align-middle" id="recommendTable">
                                <thead class="table-light"><tr><th>ä¹¦å</th><th>ISBN</th><th>ç”³è¯·æ—¥æœŸ</th><th>çŠ¶æ€</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-profile">
                    <div class="card section-card" style="max-width: 600px; margin: 0 auto;">
                        <div class="card-header"><h5 class="card-title text-secondary"><i class="fas fa-user-shield me-2"></i>è´¦å·å®‰å…¨è®¾ç½®</h5></div>
                        <div class="card-body p-4">
                            <div class="mb-4 pb-3 border-bottom">
                                <label class="form-label text-muted">å½“å‰ç™»å½•å¡å·</label>
                                <div class="fs-4 fw-bold text-dark" id="profileCardId"></div>
                            </div>
                            <h6 class="mb-3">ä¿®æ”¹ç™»å½•å¯†ç </h6>
                            <div class="mb-3">
                                <label class="form-label">æ—§å¯†ç </label>
                                <input type="password" id="oldPass" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æ–°å¯†ç </label>
                                <input type="password" id="newPass" class="form-control">
                            </div>
                            <button class="btn btn-warning w-100" onclick="changePassword()"><i class="fas fa-save me-1"></i> ä¿å­˜æ–°å¯†ç </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<div class="modal fade" id="bookDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">å›¾ä¹¦è¯¦æƒ…</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3"><strong>ä¹¦å:</strong> <span id="detailTitle" class="fs-5"></span></div>
                    <div class="col-md-6 mb-3"><strong>åˆ†ç±»:</strong> <span id="detailCategory" class="badge bg-info text-dark"></span></div>
                    <div class="col-md-6 mb-3"><strong>ä½œè€…:</strong> <span id="detailAuthor"></span></div>
                    <div class="col-md-6 mb-3"><strong>ISBN:</strong> <span id="detailIsbn"></span></div>
                    <div class="col-md-6 mb-3"><strong>å‡ºç‰ˆç¤¾:</strong> <span id="detailPublisher"></span></div>
                    <div class="col-md-6 mb-3"><strong>ä»·æ ¼:</strong> <span id="detailPrice" class="text-danger fw-bold"></span> å…ƒ</div>
                    <div class="col-md-6 mb-3"><strong>çŠ¶æ€:</strong> <span id="detailStatus"></span></div>
                </div>
                <hr><h6 class="fw-bold">å†…å®¹æ‘˜è¦:</h6><div id="detailSummary" class="summary-box">æš‚æ— ç®€ä»‹...</div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="recommendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white"><h5 class="modal-title">ğŸ“š æäº¤æ–°ä¹¦èè´­</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label>ä¹¦å <span class="text-danger">*</span></label><input type="text" id="recTitle" class="form-control"></div>
                <div class="mb-3"><label>ISBN <span class="text-danger">*</span></label><input type="text" id="recIsbn" class="form-control"></div>
                <div class="mb-3"><label>ä½œè€…</label><input type="text" id="recAuthor" class="form-control"></div>
                <div class="mb-3"><label>å‡ºç‰ˆç¤¾</label><input type="text" id="recPublisher" class="form-control"></div>
                <div class="mb-3"><label>å‚è€ƒä»·æ ¼</label><input type="number" id="recPrice" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitRecommend()">æäº¤ç”³è¯·</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 1. åŸºç¡€è®¤è¯ä¸åˆå§‹åŒ– ---
    const currentCardId = localStorage.getItem('cardId');
    if (localStorage.getItem('role') !== 'reader' || !currentCardId) {
        alert("â›” ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
        window.location.href = 'login.html';
    }

    document.getElementById('topCardId').innerText = currentCardId;
    document.getElementById('profileCardId').innerText = currentCardId;

    let currentBooksList = [];
    const bookDetailModal = new bootstrap.Modal(document.getElementById('bookDetailModal'));

    function logout() {
        if(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    }

    // --- 2. é¦†è—æŸ¥è¯¢æ¨¡å— ---
    function filterByCategory(c) { document.getElementById('searchInput').value = c; searchBooks(); }
    async function searchBooks() { const k = document.getElementById('searchInput').value; renderBookTable(k ? `/api/books/search?keyword=${k}` : '/api/books'); }
    async function loadBooks() { document.getElementById('searchInput').value = ''; renderBookTable('/api/books'); }

    async function renderBookTable(url) {
        try {
            const res = await fetch(url);
            currentBooksList = await res.json();
            const tbody = document.querySelector('#bookTable tbody');
            tbody.innerHTML = '';

            if(currentBooksList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">æœªæ‰¾åˆ°ç›¸å…³å›¾ä¹¦</td></tr>';
                return;
            }

            currentBooksList.forEach(book => {
                const statusBadge = book.status === 'åœ¨åº“'
                    ? '<span class="badge bg-success status-badge">åœ¨åº“</span>'
                    : '<span class="badge bg-danger status-badge">å·²å€Ÿå‡º</span>';

                tbody.innerHTML += `
                    <tr onclick="showBookDetail('${book.isbn}')" style="cursor:pointer">
                        <td>${book.isbn}</td>
                        <td class="fw-bold">${book.title}</td>
                        <td><span class="badge bg-secondary">${book.category||'å…¶ä»–'}</span></td>
                        <td>${book.author||'-'}</td>
                        <td>${statusBadge}</td>
                        <td><button class="btn btn-sm btn-outline-primary">è¯¦æƒ…</button></td>
                    </tr>`;
            });
        } catch(e) { console.error(e); }
    }

    function showBookDetail(isbn) {
        const b = currentBooksList.find(i=>i.isbn===isbn); if(!b) return;
        document.getElementById('detailTitle').innerText = b.title;
        document.getElementById('detailCategory').innerText = b.category||'-';
        document.getElementById('detailAuthor').innerText = b.author;
        document.getElementById('detailIsbn').innerText = b.isbn;
        document.getElementById('detailPublisher').innerText = b.publisher;
        document.getElementById('detailPrice').innerText = b.price;
        document.getElementById('detailStatus').innerHTML = b.status === 'åœ¨åº“' ? '<span class="text-success fw-bold">åœ¨åº“</span>' : '<span class="text-danger fw-bold">å·²å€Ÿå‡º</span>';
        document.getElementById('detailSummary').innerText = b.summary || 'æš‚æ— ç®€ä»‹...';
        bookDetailModal.show();
    }

    // --- 3. æˆ‘çš„ä¹¦æ¶æ¨¡å— ---
    async function loadMyBooks() {
        const res = await fetch(`/api/reader/borrowings?cardId=${currentCardId}`);
        const data = await res.json();
        const tbody = document.querySelector('#borrowTable tbody');
        const emptyDiv = document.getElementById('emptyBookshelf');

        tbody.innerHTML = '';
        if(data.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            data.forEach(item => {
                let statusHtml = '<span class="badge bg-success">æ­£å¸¸</span>';
                if (item.overdueDays > 0) statusHtml = `<span class="badge bg-danger">é€¾æœŸ ${item.overdueDays} å¤©</span>`;

                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${item.title}</td>
                        <td>${item.borrowTime ? item.borrowTime.split('T')[0] : '-'}</td>
                        <td class="${item.overdueDays > 0 ? 'text-danger fw-bold' : ''}">${item.dueTime ? item.dueTime.split('T')[0] : '-'}</td>
                        <td>${statusHtml}</td>
                        <td><button class="btn btn-sm btn-warning" onclick="returnBook(${item.id})">å½’è¿˜</button></td>
                    </tr>`;
            });
        }
    }

    async function returnBook(id) {
        if(confirm("ç¡®å®šè¦å½’è¿˜è¿™æœ¬ä¹¦å—?")) {
            const res = await fetch('/api/reader/return', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({borrowId:id})
            });
            const data = await res.json();
            alert(data.msg);
            loadMyBooks(); // åˆ·æ–°ä¹¦æ¶
            loadMyFines(); // åˆ·æ–°ç½šæ¬¾ï¼ˆå¦‚æœæœ‰ï¼‰
        }
    }

    // --- 4. å€Ÿé˜…ä¸ç½šæ¬¾æ¨¡å— ---
    async function borrowBook() {
        const isbn = document.getElementById('borrowIsbn').value;
        if(!isbn) return alert("è¯·è¾“å…¥ISBN");

        const resDiv = document.getElementById('borrowResult');
        resDiv.innerText = "å¤„ç†ä¸­..."; resDiv.className = "mt-3 text-muted";

        try {
            const res = await fetch('/api/borrow', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ cardId: currentCardId, isbn })
            });
            const text = await res.text();
            resDiv.innerText = text;
            resDiv.className = text.includes("æˆåŠŸ") ? "mt-3 text-success fw-bold" : "mt-3 text-danger fw-bold";
            if(text.includes("æˆåŠŸ")) {
                document.getElementById('borrowIsbn').value = ''; // æ¸…ç©ºè¾“å…¥
                loadMyBooks(); // åˆ·æ–°ä¹¦æ¶æ•°æ®
            }
        } catch(e) { resDiv.innerText = "ç½‘ç»œé”™è¯¯"; }
    }

    async function loadMyFines() {
        const res = await fetch(`/api/reader/fines?cardId=${currentCardId}`);
        const data = await res.json();
        const tbody = document.querySelector('#fineTable tbody');
        const emptyDiv = document.getElementById('emptyFines');

        tbody.innerHTML = '';
        if(data.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            data.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td>${item.title}</td>
                        <td class="text-danger fw-bold">ï¿¥${item.fineAmount}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="payFine(${item.id})">ç¼´çº³</button></td>
                    </tr>`;
            });
        }
    }

    async function payFine(id) {
        if(confirm("ç¡®è®¤ç¼´çº³æ­¤ç¬”ç½šæ¬¾ï¼Ÿ")) {
            const res = await fetch('/api/reader/pay', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({borrowId:id})
            });
            const data = await res.json();
            alert(data.msg);
            loadMyFines();
        }
    }

    // --- 5. èè´­æ¨¡å— ---
    async function loadMyRecommends() {
        const res = await fetch(`/api/recommend/list?readerId=${currentCardId}`);
        const data = await res.json();
        const tbody = document.querySelector('#recommendTable tbody');
        tbody.innerHTML = '';
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æš‚æ— èè´­è®°å½•</td></tr>';
            return;
        }

        data.forEach(item => {
            let badge = 'bg-secondary';
            if(item.status.includes('æ‰¹å‡†') || item.status.includes('å…¥åº“')) badge = 'bg-success';
            if(item.status.includes('é©³å›')) badge = 'bg-danger';

            tbody.innerHTML += `
            <tr>
                <td class="fw-bold">${item.title}</td>
                <td>${item.isbn}</td>
                <td>${item.requestDate.split('T')[0]}</td>
                <td><span class="badge ${badge}">${item.status}</span></td>
            </tr>`;
        });
    }

    async function submitRecommend() {
        const body = {
            title: document.getElementById('recTitle').value,
            isbn: document.getElementById('recIsbn').value,
            author: document.getElementById('recAuthor').value,
            publisher: document.getElementById('recPublisher').value,
            price: document.getElementById('recPrice').value || 0,
            readerId: currentCardId
        };
        if(!body.title || !body.isbn) return alert("ä¹¦åå’ŒISBNå¿…å¡«");

        const res = await fetch('/api/recommend/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        const data = await res.json();
        alert(data.msg);
        if(data.success) {
            bootstrap.Modal.getInstance(document.getElementById('recommendModal')).hide();
            loadMyRecommends();
            // æ¸…ç©ºè¡¨å•
            document.querySelectorAll('#recommendModal input').forEach(input => input.value = '');
        }
    }

    // --- 6. ä¸ªäººä¸­å¿ƒæ¨¡å— ---
    async function changePassword() {
        const oldPass = document.getElementById('oldPass').value;
        const newPass = document.getElementById('newPass').value;
        if (!oldPass || !newPass) return alert("è¯·å¡«å†™å®Œæ•´å¯†ç ä¿¡æ¯");

        try {
            const res = await fetch('/api/reader/password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ cardId: currentCardId, oldPass, newPass })
            });
            const data = await res.json();
            alert(data.msg);
            if(data.success) {
                document.getElementById('oldPass').value = '';
                document.getElementById('newPass').value = '';
            }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
    }

    // åˆå§‹åŒ–åŠ è½½
    document.addEventListener('DOMContentLoaded', () => {
        loadBooks();
    });
</script>
</body>
</html>