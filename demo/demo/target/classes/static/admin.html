<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†ç³»ç»Ÿ - å›¾ä¹¦é¦†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; padding-top: 56px; font-family: "Microsoft YaHei", sans-serif; }
    .navbar { position: fixed; top: 0; width: 100%; z-index: 1030; }
    .sidebar { position: fixed; top: 56px; bottom: 0; left: 0; z-index: 1000; padding: 15px 0; background-color: #343a40; color: white; width: 220px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    .sidebar .nav-link { color: #f8f9fa; padding: 10px 15px; border-left: 3px solid transparent; transition: all 0.2s; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background-color: #495057; border-left-color: #007bff; font-weight: bold; }
    .content-area { margin-left: 220px; padding: 25px; }
    .section-card { border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .card-title { font-weight: bold; color: #007bff; }
    .summary-box { background-color: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; color: #555; }
    tr.book-row:hover { background-color: #f1f1f1; cursor: pointer; }
    .config-table-container { max-height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; }
    .config-table-container thead th { position: sticky; top: 0; background: #343a40; color: white; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand ms-3" href="#"><i class="fas fa-university"></i> å›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿ</a>
    <div class="d-flex align-items-center me-3">
      <span class="text-light me-3">ç®¡ç†å‘˜: <strong class="text-warning">admin</strong></span>
      <button class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#adminPassModal"><i class="fas fa-key"></i> ä¿®æ”¹å¯†ç </button>
      <button onclick="logout()" class="btn btn-outline-danger btn-sm"><i class="fas fa-sign-out-alt"></i> é€€å‡º</button>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <nav id="sidebar" class="sidebar">
      <div class="position-sticky">
        <ul class="nav flex-column nav-pills" id="adminTabs">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#tab-query"><i class="fas fa-search me-2"></i> é¦†è—å›¾ä¹¦æŸ¥è¯¢</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-rec"><i class="fas fa-gavel me-2"></i> èè´­å®¡æ ¸</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-add-book"><i class="fas fa-book me-2"></i> å›¾ä¹¦ç™»è®° (å…¥åº“)</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-reader-reg"><i class="fas fa-user-plus me-2"></i> è¯»è€…ç™»è®° (åŠè¯)</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-operation"><i class="fas fa-exchange-alt me-2"></i> å€Ÿè¿˜ä¸æ³¨é”€</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-config" id="configTabLink"><i class="fas fa-cogs me-2"></i> ç³»ç»Ÿå‚æ•°è®¾ç½®</a></li>
        </ul>
      </div>
    </nav>

    <main class="col-md-9 ms-sm-auto col-lg-10 content-area">
      <div class="tab-content">

        <div class="tab-pane fade show active" id="tab-query">
          <div class="card section-card">
            <div class="card-header bg-white"><h4 class="card-title text-secondary"><i class="fas fa-search me-2"></i> é¦†è—å›¾ä¹¦æŸ¥è¯¢ä¸ç®¡ç†</h4></div>
            <div class="card-body">
              <div class="input-group mb-3">
                <input type="text" id="searchInput" class="form-control" placeholder="è¾“å…¥ä¹¦åã€ISBN æˆ–ä½œè€…...">
                <button class="btn btn-outline-secondary" onclick="searchBooks()">ğŸ” æœç´¢</button>
                <button class="btn btn-outline-secondary" onclick="loadBooks()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
              </div>
              <div class="category-tags mb-3">
                <span class="text-muted me-2"><i class="fas fa-filter"></i> å¿«é€Ÿç­›é€‰:</span>
                <button class="btn btn-outline-secondary btn-sm" onclick="filterByCategory('')">å…¨éƒ¨</button>
                <button class="btn btn-outline-info btn-sm" onclick="filterByCategory('è®¡ç®—æœº')">ğŸ’» è®¡ç®—æœº</button>
                <button class="btn btn-outline-warning btn-sm" onclick="filterByCategory('å†å²')">ğŸ“œ å†å²</button>
                <button class="btn btn-outline-success btn-sm" onclick="filterByCategory('é‡‘è')">ğŸ’° é‡‘è</button>
                <button class="btn btn-outline-danger btn-sm" onclick="filterByCategory('è‹±è¯­')">ğŸ…°ï¸ è‹±è¯­</button>
                <button class="btn btn-outline-primary btn-sm" onclick="filterByCategory('æ•°å­¦')">ğŸ“ æ•°å­¦</button>
                <button class="btn btn-outline-dark btn-sm" onclick="filterByCategory('æ–‡å­¦')">ğŸ“– æ–‡å­¦</button>
              </div>
              <table class="table table-hover align-middle" id="bookTable">
                <thead class="table-light"><tr><th>ISBN</th><th>ä¹¦å</th><th>åˆ†ç±»</th><th>ä½œè€…</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-rec">
          <div class="card section-card">
            <div class="card-header bg-white"><h4 class="card-title" style="color:#6610f2"><i class="fas fa-gavel me-2"></i> èè´­å®¡æ ¸</h4></div>
            <div class="card-body">
              <div class="d-flex justify-content-end mb-3">
                <button onclick="loadRecommends()" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync"></i> åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨</button>
              </div>
              <table class="table table-hover align-middle" id="recTable">
                <thead class="table-light"><tr><th>ISBN</th><th>ä¹¦å</th><th>æ¨èäºº</th><th>ä»·æ ¼</th><th>æ“ä½œ</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-add-book">
          <div class="card section-card">
            <div class="card-header bg-white"><h4 class="card-title text-success"><i class="fas fa-book me-2"></i> å›¾ä¹¦ç™»è®° (å…¥åº“)</h4></div>
            <div class="card-body">
              <div class="row g-3 mb-3">
                <div class="col-md-3"><label class="form-label fw-bold">ä¹¦å· (ISBN)</label><input type="text" id="addBookIsbn" class="form-control" placeholder="978-001"></div>
                <div class="col-md-3"><label class="form-label fw-bold">ä¹¦å</label><input type="text" id="addBookTitle" class="form-control" placeholder="ä¾‹å¦‚: æ•°æ®åº“åŸç†"></div>
                <div class="col-md-3"><label class="form-label fw-bold">åˆ†ç±»</label>
                  <select id="addBookCategory" class="form-select">
                    <option value="è®¡ç®—æœº">ğŸ’» è®¡ç®—æœº</option><option value="å†å²">ğŸ“œ å†å²</option><option value="è‹±è¯­">ğŸ…°ï¸ è‹±è¯­</option>
                    <option value="æ•°å­¦">ğŸ“ æ•°å­¦</option><option value="é‡‘è">ğŸ’° é‡‘è</option><option value="æ–‡å­¦">ğŸ“– æ–‡å­¦</option><option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                  </select>
                </div>
                <div class="col-md-3"><label class="form-label fw-bold">ä½œè€…</label><input type="text" id="addBookAuthor" class="form-control"></div>
              </div>
              <div class="row g-3 align-items-end">
                <div class="col-md-3"><label class="form-label fw-bold">ä»·æ ¼</label><input type="number" id="addBookPrice" class="form-control"></div>
                <div class="col-md-3"><label class="form-label fw-bold">å‡ºç‰ˆç¤¾</label><input type="text" id="addBookPublisher" class="form-control"></div>
                <div class="col-md-4"><label class="form-label fw-bold">æ‘˜è¦</label><textarea id="addBookSummary" class="form-control" rows="1" placeholder="ç®€ä»‹..."></textarea></div>
                <div class="col-md-2"><button onclick="addBook()" class="btn btn-success w-100"><i class="fas fa-plus"></i> æ·»åŠ å›¾ä¹¦</button></div>
              </div>
              <span id="addBookResult" class="result-msg"></span>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-reader-reg">
          <div class="card section-card">
            <div class="card-header bg-white"><h4 class="card-title text-info"><i class="fas fa-user-plus me-2"></i>è¯»è€…ç™»è®° (åŠè¯)</h4></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-2"><input type="text" id="addReaderId" class="form-control" placeholder="å¡å·"></div>
                <div class="col-md-2"><input type="text" id="addReaderName" class="form-control" placeholder="å§“å"></div>
                <div class="col-md-2"><input type="text" id="addReaderPass" class="form-control" placeholder="å¯†ç  (é»˜è®¤123456)"></div>
                <div class="col-md-2"><select id="addReaderSex" class="form-select"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
                <div class="col-md-2"><input type="text" id="addReaderDeptId" class="form-control" placeholder="å•ä½"></div>
                <div class="col-md-2"><select id="addReaderType" class="form-select" onchange="updateLevelOptions()"><option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option><option value="æ•™å¸ˆ">æ•™å¸ˆ</option></select></div>
                <div class="col-md-2"><select id="addReaderLevel" class="form-select"></select></div>
                <div class="col-md-2"><button onclick="addReader()" class="btn btn-info text-white w-100">æ³¨å†Œ</button></div>
              </div>
              <span id="addReaderResult" class="result-msg"></span>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-operation">
          <div class="row">
            <div class="col-md-6">
              <div class="card section-card">
                <div class="card-header bg-white"><h4 class="card-title" style="color:#6f42c1"><i class="fas fa-user-slash me-2"></i>è¯»è€…æ³¨é”€</h4></div>
                <div class="card-body">
                  <div class="input-group">
                    <input type="text" id="cancelCardId" class="form-control" placeholder="è¾“å…¥å¡å·">
                    <button onclick="cancelReader()" class="btn btn-danger">æ³¨é”€</button>
                  </div>
                  <span id="cancelResult" class="result-msg"></span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card section-card">
                <div class="card-header bg-white"><h4 class="card-title text-danger"><i class="fas fa-undo me-2"></i>è¿˜ä¹¦åŠç† (æŸœå°)</h4></div>
                <div class="card-body">
                  <div class="input-group">
                    <input type="text" id="returnIsbn" class="form-control" placeholder="è¾“å…¥å›¾ä¹¦ ISBN">
                    <button onclick="returnBook()" class="btn btn-primary">ç¡®è®¤å½’è¿˜</button>
                  </div>
                  <span id="returnResult" class="result-msg"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-config">
          <div class="card section-card">
            <div class="card-header bg-white"><h4 class="card-title text-warning text-dark"><i class="fas fa-cogs me-2"></i>ç³»ç»Ÿå‚æ•°è®¾ç½®</h4></div>
            <div class="card-body">
              <div class="mb-4">
                <h6>ç½šæ¬¾å‚æ•°</h6>
                <div class="row align-items-center">
                  <div class="col-auto"><label class="col-form-label">ç½šæ¬¾(å…ƒ/å¤©):</label></div>
                  <div class="col-auto"><input type="number" id="configValue" class="form-control" placeholder="0.5"></div>
                  <div class="col-auto"><button onclick="updateConfig()" class="btn btn-warning">ğŸ’¾ ä¿å­˜è®¾ç½®</button></div>
                </div>
                <span id="configResult" class="result-msg"></span>
              </div>
              <h6 class="mt-4">å½“å‰å€Ÿé˜…è§„åˆ™ç®¡ç† (ç‚¹å‡»ä¿®æ”¹å³å¯ä¿å­˜)</h6>
              <div class="config-table-container">
                <table class="table table-striped table-bordered mb-0" id="ruleTable">
                  <thead class="table-dark"><tr><th>è¯»è€…ç±»å‹/çº§åˆ«</th><th>æœ€å¤§å€Ÿé˜…æ•°é‡</th><th>æœ€é•¿å€Ÿé˜…å¤©æ•°</th><th>æ“ä½œ</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <span id="ruleLoadStatus" class="result-msg"></span>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>
</div>

<div class="modal fade" id="editRuleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="fas fa-edit"></i> ä¿®æ”¹å€Ÿé˜…è§„åˆ™</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 id="ruleTitle" class="mb-3 fw-bold">æ­£åœ¨ä¿®æ”¹ï¼šæœ¬ç§‘ç”Ÿ</h6>
        <div class="mb-3">
          <label class="form-label">æœ€å¤§å€Ÿé˜…æ•°é‡ (æœ¬)</label>
          <input type="number" id="editRuleMax" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">æœ€é•¿å€Ÿé˜…å¤©æ•° (å¤©)</label>
          <input type="number" id="editRuleDays" class="form-control">
        </div>
        <input type="hidden" id="editRuleMaxKey">
        <input type="hidden" id="editRuleDaysKey">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="submitEditRule()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editBookModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark"><h5 class="modal-title"><i class="fas fa-edit"></i> ä¿®æ”¹å›¾ä¹¦ä¿¡æ¯</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row g-3 mb-3">
          <div class="col-md-6"><label class="form-label fw-bold">ä¹¦å· (ISBN) - ä¸å¯ä¿®æ”¹</label><input type="text" id="editBookIsbn" class="form-control" readonly style="background-color: #e9ecef;"></div>
          <div class="col-md-6"><label class="form-label fw-bold">ä¹¦å</label><input type="text" id="editBookTitle" class="form-control"></div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6"><label class="form-label fw-bold">åˆ†ç±»</label>
            <select id="editBookCategory" class="form-select">
              <option value="è®¡ç®—æœº">ğŸ’» è®¡ç®—æœº</option><option value="å†å²">ğŸ“œ å†å²</option><option value="è‹±è¯­">ğŸ…°ï¸ è‹±è¯­</option>
              <option value="æ•°å­¦">ğŸ“ æ•°å­¦</option><option value="é‡‘è">ğŸ’° é‡‘è</option><option value="æ–‡å­¦">ğŸ“– æ–‡å­¦</option><option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
            </select>
          </div>
          <div class="col-md-6"><label class="form-label fw-bold">ä½œè€…</label><input type="text" id="editBookAuthor" class="form-control"></div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6"><label class="form-label fw-bold">ä»·æ ¼</label><input type="number" id="editBookPrice" class="form-control"></div>
          <div class="col-md-6"><label class="form-label fw-bold">å‡ºç‰ˆç¤¾</label><input type="text" id="editBookPublisher" class="form-control"></div>
        </div>
        <div class="mb-3"><label class="form-label fw-bold">æ‘˜è¦</label><textarea id="editBookSummary" class="form-control" rows="3"></textarea></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" onclick="submitEditBook()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="bookDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title">å›¾ä¹¦è¯¦æƒ…ä¿¡æ¯</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3"><strong>ä¹¦å:</strong> <span id="detailTitle" class="fs-5"></span></div>
          <div class="col-md-6 mb-3"><strong>åˆ†ç±»:</strong> <span id="detailCategory" class="badge bg-info text-dark"></span></div>
          <div class="col-md-6 mb-3"><strong>ä½œè€…:</strong> <span id="detailAuthor"></span></div>
          <div class="col-md-6 mb-3"><strong>ISBN:</strong> <span id="detailIsbn"></span></div>
          <div class="col-md-6 mb-3"><strong>å‡ºç‰ˆç¤¾:</strong> <span id="detailPublisher"></span></div>
          <div class="col-md-6 mb-3"><strong>ä»·æ ¼:</strong> <span id="detailPrice" class="text-danger fw-bold"></span> å…ƒ</div>
          <div class="col-md-6 mb-3"><strong>çŠ¶æ€:</strong> <span id="detailStatus"></span></div>
        </div>
        <hr><h6 class="fw-bold">å†…å®¹æ‘˜è¦:</h6><div id="detailSummary" class="summary-box">æš‚æ— ç®€ä»‹...</div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="adminPassModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">ç®¡ç†å‘˜å¯†ç ä¿®æ”¹</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-3"><label>æ—§å¯†ç </label><input type="password" id="adminOldPass" class="form-control"></div>
        <div class="mb-3"><label>æ–°å¯†ç </label><input type="password" id="adminNewPass" class="form-control"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="changeAdminPassword()">ç¡®è®¤ä¿®æ”¹</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  if (localStorage.getItem('role') !== 'admin') {
    alert("â›” éæ³•è®¿é—®ï¼è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·ã€‚"); window.location.href = 'login.html';
  }
  let currentBooksList = [];
  const CONFIG_KEYS = [
    { type: "æœ¬ç§‘ç”Ÿ", key: "undergrad", defaultMax: '5', defaultDays: '30' },
    { type: "ç ”ç©¶ç”Ÿ", key: "grad", defaultMax: '10', defaultDays: '60' },
    { type: "åšå£«ç”Ÿ", key: "phd", defaultMax: '15', defaultDays: '90' },
    { type: "æ•™å¸ˆ", key: "teacher", defaultMax: '20', defaultDays: '90' }
  ];

  function logout() {
    if(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) { localStorage.clear(); window.location.href = 'login.html'; }
  }

  // --- é…ç½®è·å– ---
  async function getConfigValue(key) {
    try {
      const res = await fetch(`/api/config/value?key=${key}`);
      const text = await res.text();
      return (text === "null" || text === "") ? null : text;
    } catch (e) { return null; }
  }

  // --- Tab 6: ç³»ç»Ÿå‚æ•°è®¾ç½®é€»è¾‘ ---
  async function loadConfig() {
    const rate = await getConfigValue('overdue_fine_rate'); document.getElementById('configValue').value = rate || '1.00';
    const tbody = document.querySelector('#ruleTable tbody'); tbody.innerHTML = '';
    document.getElementById('ruleLoadStatus').innerText = "åŠ è½½ä¸­...";
    try {
      for (const k of CONFIG_KEYS) {
        const maxKey = k.key + '_max_borrow';
        const daysKey = k.key + '_borrow_days';
        const max = await getConfigValue(maxKey) || k.defaultMax;
        const days = await getConfigValue(daysKey) || k.defaultDays;

        const tr = document.createElement('tr');
        tr.innerHTML = `
                <td>${k.type}</td>
                <td><span id="view_max_${k.key}">${max}</span> æœ¬</td>
                <td><span id="view_days_${k.key}">${days}</span> å¤©</td>
                <td><button class="btn btn-sm btn-warning" onclick="openEditRule('${k.type}', '${maxKey}', '${daysKey}', '${max}', '${days}')"><i class="fas fa-edit"></i> ä¿®æ”¹</button></td>
              `;
        tbody.appendChild(tr);
      }
      document.getElementById('ruleLoadStatus').innerText = "âœ… è§„åˆ™åŠ è½½å®Œæˆ";
    } catch (e) { document.getElementById('ruleLoadStatus').innerText = "âŒ è§„åˆ™åŠ è½½å¤±è´¥"; }
  }
  document.getElementById('configTabLink').addEventListener('click', loadConfig);

  // âœ… [æ–°å¢] æ‰“å¼€å€Ÿé˜…è§„åˆ™ä¿®æ”¹æ¨¡æ€æ¡†
  const editRuleModal = new bootstrap.Modal(document.getElementById('editRuleModal'));
  function openEditRule(type, maxKey, daysKey, currentMax, currentDays) {
    document.getElementById('ruleTitle').innerText = "æ­£åœ¨ä¿®æ”¹ï¼š" + type;
    document.getElementById('editRuleMaxKey').value = maxKey;
    document.getElementById('editRuleDaysKey').value = daysKey;
    document.getElementById('editRuleMax').value = currentMax;
    document.getElementById('editRuleDays').value = currentDays;
    editRuleModal.show();
  }

  // âœ… [æ–°å¢] æäº¤å€Ÿé˜…è§„åˆ™ä¿®æ”¹
  async function submitEditRule() {
    const maxKey = document.getElementById('editRuleMaxKey').value;
    const daysKey = document.getElementById('editRuleDaysKey').value;
    const newValMax = document.getElementById('editRuleMax').value;
    const newValDays = document.getElementById('editRuleDays').value;

    if (!newValMax || !newValDays) return alert("è¯·å¡«å†™å®Œæ•´æ•°å€¼");

    // ä¸²è¡Œæ›´æ–°ä¸¤ä¸ªå€¼
    await apiCall('/api/config/update', { key: maxKey, value: newValMax });
    await apiCall('/api/config/update', { key: daysKey, value: newValDays });

    alert("âœ… è§„åˆ™ä¿®æ”¹æˆåŠŸï¼");
    editRuleModal.hide();
    loadConfig(); // åˆ·æ–°è¡¨æ ¼
  }

  // --- ä¸šåŠ¡æ“ä½œå‡½æ•° ---
  async function apiCall(url, body, resultId, callback) {
    if(resultId) { document.getElementById(resultId).innerText = "å¤„ç†ä¸­..."; document.getElementById(resultId).className = "result-msg"; }
    try {
      const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
      const data = await res.json();
      if(data.success || !data.error) {
        if(resultId) { document.getElementById(resultId).innerText = "âœ… " + (data.msg || "æ“ä½œæˆåŠŸ"); document.getElementById(resultId).className = "result-msg success"; }
        if(url.includes('/book')) loadBooks();
        if(callback) callback();
      } else {
        if(resultId) { document.getElementById(resultId).innerText = "âŒ " + (data.error || data.msg); document.getElementById(resultId).className = "result-msg error"; }
      }
    } catch (e) {
      if(resultId) { document.getElementById(resultId).innerText = "âŒ ç½‘ç»œé”™è¯¯"; document.getElementById(resultId).className = "result-msg error"; }
    }
  }

  function addBook() {
    apiCall('/api/book', {
      isbn: document.getElementById('addBookIsbn').value, title: document.getElementById('addBookTitle').value,
      category: document.getElementById('addBookCategory').value, author: document.getElementById('addBookAuthor').value,
      price: document.getElementById('addBookPrice').value, publisher: document.getElementById('addBookPublisher').value,
      summary: document.getElementById('addBookSummary').value, status: "åœ¨åº“"
    }, 'addBookResult');
  }
  function addReader() {
    apiCall('/api/reader', {
      cardId: document.getElementById('addReaderId').value, name: document.getElementById('addReaderName').value,
      password: document.getElementById('addReaderPass').value, sex: document.getElementById('addReaderSex').value,
      deptId: document.getElementById('addReaderDeptId').value, type: document.getElementById('addReaderType').value,
      level: document.getElementById('addReaderLevel').value, isActive: true
    }, 'addReaderResult');
  }
  function cancelReader() { if(confirm("ç¡®å®šæ³¨é”€?")) apiCall('/api/reader/cancel', { cardId: document.getElementById('cancelCardId').value }, 'cancelResult'); }
  function returnBook() { apiCall('/api/return', { isbn: document.getElementById('returnIsbn').value }, 'returnResult'); }
  function updateConfig() { apiCall('/api/config/update', { key: 'overdue_fine_rate', value: document.getElementById('configValue').value }, 'configResult'); }

  // --- å›¾ä¹¦ç®¡ç† & ç¼–è¾‘ ---
  function filterByCategory(category) { document.getElementById('searchInput').value = category; searchBooks(); }
  async function searchBooks() { const k = document.getElementById('searchInput').value; renderBookTable(k ? `/api/books/search?keyword=${k}` : '/api/books'); }
  async function loadBooks() { document.getElementById('searchInput').value = ''; renderBookTable('/api/books'); }
  async function renderBookTable(url) {
    try {
      const res = await fetch(url); currentBooksList = await res.json();
      const tbody = document.querySelector('#bookTable tbody'); tbody.innerHTML = '';
      if(currentBooksList.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æœªæ‰¾åˆ°å›¾ä¹¦</td></tr>'; return; }
      currentBooksList.forEach(book => {
        const statusColor = book.status === 'åœ¨åº“' ? 'text-success' : 'text-danger';
        tbody.innerHTML += `<tr class="book-row">
                  <td onclick="showBookDetail('${book.isbn}')">${book.isbn}</td><td onclick="showBookDetail('${book.isbn}')">${book.title}</td>
                  <td onclick="showBookDetail('${book.isbn}')"><span class="badge bg-secondary">${book.category||'å…¶ä»–'}</span></td>
                  <td onclick="showBookDetail('${book.isbn}')">${book.author||'-'}</td><td onclick="showBookDetail('${book.isbn}')" class="${statusColor} fw-bold">${book.status}</td>
                  <td><button class="btn btn-sm btn-outline-primary me-1" onclick="showBookDetail('${book.isbn}')">è¯¦æƒ…</button>
                      <button class="btn btn-sm btn-warning text-dark" onclick="openEditModal('${book.isbn}')"><i class="fas fa-edit"></i> ä¿®æ”¹</button></td></tr>`;
      });
    } catch(e) {}
  }
  const editModal = new bootstrap.Modal(document.getElementById('editBookModal'));
  function openEditModal(isbn) {
    const book = currentBooksList.find(b => b.isbn === isbn); if (!book) return;
    document.getElementById('editBookIsbn').value = book.isbn; document.getElementById('editBookTitle').value = book.title;
    document.getElementById('editBookCategory').value = book.category || 'å…¶ä»–'; document.getElementById('editBookAuthor').value = book.author;
    document.getElementById('editBookPrice').value = book.price; document.getElementById('editBookPublisher').value = book.publisher;
    document.getElementById('editBookSummary').value = book.summary; editModal.show();
  }
  function submitEditBook() {
    apiCall('/api/book', {
      isbn: document.getElementById('editBookIsbn').value, title: document.getElementById('editBookTitle').value,
      category: document.getElementById('editBookCategory').value, author: document.getElementById('editBookAuthor').value,
      price: document.getElementById('editBookPrice').value, publisher: document.getElementById('editBookPublisher').value,
      summary: document.getElementById('editBookSummary').value, status: "åœ¨åº“"
    }, null, () => { editModal.hide(); alert("âœ… ä¿®æ”¹æˆåŠŸï¼"); });
  }
  function showBookDetail(isbn) {
    const b = currentBooksList.find(i => i.isbn === isbn); if (!b) return;
    document.getElementById('detailTitle').innerText = b.title; document.getElementById('detailCategory').innerText = b.category||'å…¶ä»–';
    document.getElementById('detailAuthor').innerText = b.author; document.getElementById('detailIsbn').innerText = b.isbn;
    document.getElementById('detailPublisher').innerText = b.publisher; document.getElementById('detailPrice').innerText = b.price;
    document.getElementById('detailStatus').innerText = b.status; document.getElementById('detailSummary').innerText = b.summary || 'æš‚æ— ';
    new bootstrap.Modal(document.getElementById('bookDetailModal')).show();
  }

  // --- èè´­ ---
  async function loadRecommends() {
    const res = await fetch('/api/recommend/list'); const data = await res.json();
    const tbody = document.querySelector('#recTable tbody'); tbody.innerHTML = '';
    if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— å¾…å®¡æ ¸è¯·æ±‚</td></tr>'; return; }
    data.forEach(item => {
      tbody.innerHTML += `<tr><td>${item.isbn}</td><td>${item.title}</td><td>${item.readerId}</td><td>${item.price||'-'}</td>
              <td><button class="btn btn-sm btn-success me-1" onclick="handleRec(${item.id}, true)">æ‰¹å‡†</button><button class="btn btn-sm btn-danger" onclick="handleRec(${item.id}, false)">é©³å›</button></td></tr>`;
    });
  }
  async function handleRec(id, approved) {
    if(!confirm(approved ? "ç¡®å®šæ‰¹å‡†å¹¶è‡ªåŠ¨å…¥åº“å—ï¼Ÿ" : "ç¡®å®šé©³å›å—ï¼Ÿ")) return;
    const res = await fetch('/api/recommend/handle', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, approved }) });
    const data = await res.json(); alert(data.msg); loadRecommends(); loadBooks();
  }

  // åˆå§‹åŒ–
  function updateLevelOptions() {
    const type = document.getElementById('addReaderType').value; const levelSelect = document.getElementById('addReaderLevel');
    levelSelect.innerHTML = '';
    let options = type === 'å­¦ç”Ÿ' ? ['æœ¬ç§‘ç”Ÿ', 'ç ”ç©¶ç”Ÿ', 'åšå£«ç”Ÿ'] : ['å‰¯æ•™æˆ', 'æ­£æ•™æˆ', 'è®²å¸ˆ'];
    options.forEach(opt => levelSelect.add(new Option(opt, opt)));
  }
  updateLevelOptions();
  async function changeAdminPassword() {
    const oldPass = document.getElementById('adminOldPass').value; const newPass = document.getElementById('adminNewPass').value;
    if (!oldPass || !newPass) return alert("è¯·å¡«å†™å®Œæ•´");
    const res = await fetch('/api/admin/password', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username: 'admin', oldPass, newPass }) });
    const data = await res.json(); alert(data.msg); if(data.success) logout();
  }
  document.addEventListener('DOMContentLoaded', () => { loadBooks(); loadRecommends(); });
</script>
</body>
</html>