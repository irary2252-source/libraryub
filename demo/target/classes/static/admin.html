<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†ç³»ç»Ÿ - å›¾ä¹¦é¦†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; background-color: #e9ecef; padding-bottom: 50px; }
    .navbar { box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .section-card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #007bff; margin-bottom: 25px; }
    .card-body { padding: 25px; }
    .section-icon { font-size: 1.5rem; margin-right: 10px; }
    .result-msg { font-weight: bold; margin-top: 10px; display: block;}
    .success { color: #28a745; }
    .error { color: #dc3545; }

    /* æ¨¡å—è¾¹æ¡†é¢œè‰² */
    .border-book { border-left-color: #28a745; }
    .border-reader { border-left-color: #17a2b8; }
    .border-cancel { border-left-color: #6f42c1; }
    .border-return { border-left-color: #dc3545; }
    .border-config { border-left-color: #ffc107; }
    .border-query { border-left-color: #6c757d; }
    .border-rec { border-left-color: #6610f2; }

    .modal-header { background-color: #007bff; color: white; }
    .category-tags .btn { margin-right: 8px; margin-bottom: 8px; border-radius: 20px; font-size: 0.9rem; }
    tr.book-row { cursor: pointer; }
    tr.book-row:hover { background-color: #f1f1f1; }
    .summary-box { background-color: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; color: #555; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="fas fa-user-shield"></i> å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ (ç®¡ç†å‘˜)</a>
    <div class="d-flex align-items-center">
      <span class="text-light me-3">å½“å‰ç”¨æˆ·: <strong class="text-warning">admin</strong></span>
      <button class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#adminPassModal"><i class="fas fa-key"></i> ä¿®æ”¹å¯†ç </button>
      <button onclick="logout()" class="btn btn-outline-secondary btn-sm"><i class="fas fa-sign-out-alt"></i> é€€å‡º</button>
    </div>
  </div>
</nav>

<div class="container">

  <div class="card section-card border-rec">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title text-primary" style="color:#6610f2 !important"><i class="fas fa-gavel section-icon"></i> èè´­å®¡æ ¸</h4>
        <button onclick="loadRecommends()" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync"></i> åˆ·æ–°</button>
      </div>
      <table class="table table-hover align-middle" id="recTable">
        <thead class="table-light"><tr><th>ISBN</th><th>ä¹¦å</th><th>æ¨èäºº</th><th>ä»·æ ¼</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card section-card border-book">
    <div class="card-body">
      <h4 class="card-title mb-4 text-success"><i class="fas fa-book section-icon"></i>å›¾ä¹¦ç™»è®° (å…¥åº“)</h4>
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label fw-bold">ä¹¦å· (ISBN)</label>
          <input type="text" id="addBookIsbn" class="form-control" placeholder="978-001">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">ä¹¦å</label>
          <input type="text" id="addBookTitle" class="form-control" placeholder="ä¾‹å¦‚: æ•°æ®åº“åŸç†">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">åˆ†ç±»</label>
          <select id="addBookCategory" class="form-select">
            <option value="è®¡ç®—æœº">ğŸ’» è®¡ç®—æœº</option>
            <option value="å†å²">ğŸ“œ å†å²</option>
            <option value="è‹±è¯­">ğŸ…°ï¸ è‹±è¯­</option>
            <option value="æ•°å­¦">ğŸ“ æ•°å­¦</option>
            <option value="é‡‘è">ğŸ’° é‡‘è</option>
            <option value="æ–‡å­¦">ğŸ“– æ–‡å­¦</option>
            <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">ä½œè€…</label>
          <input type="text" id="addBookAuthor" class="form-control">
        </div>
      </div>
      <div class="row g-3 align-items-end">
        <div class="col-md-3"><label class="form-label fw-bold">ä»·æ ¼</label><input type="number" id="addBookPrice" class="form-control"></div>
        <div class="col-md-3"><label class="form-label fw-bold">å‡ºç‰ˆç¤¾</label><input type="text" id="addBookPublisher" class="form-control"></div>
        <div class="col-md-4"><label class="form-label fw-bold">æ‘˜è¦</label><input type="text" id="addBookSummary" class="form-control" placeholder="ç®€ä»‹..."></div>
        <div class="col-md-2"><button onclick="addBook()" class="btn btn-success w-100"><i class="fas fa-plus"></i> æ·»åŠ å›¾ä¹¦</button></div>
      </div>
      <span id="addBookResult" class="result-msg"></span>
    </div>
  </div>

  <div class="card section-card border-query">
    <div class="card-body">
      <h4 class="card-title mb-4 text-secondary"><i class="fas fa-search section-icon"></i>é¦†è—å›¾ä¹¦æŸ¥è¯¢</h4>
      <div class="input-group mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="è¾“å…¥ä¹¦åã€ISBN æˆ–ä½œè€…...">
        <button class="btn btn-outline-secondary" onclick="searchBooks()">ğŸ” æœç´¢</button>
        <button class="btn btn-outline-secondary" onclick="loadBooks()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
      </div>
      <div class="category-tags mb-3">
        <span class="text-muted me-2"><i class="fas fa-filter"></i> å¿«é€Ÿç­›é€‰:</span>
        <button class="btn btn-outline-secondary btn-sm" onclick="filterByCategory('')">å…¨éƒ¨</button>
        <button class="btn btn-outline-info btn-sm" onclick="filterByCategory('è®¡ç®—æœº')">ğŸ’» è®¡ç®—æœº</button>
        <button class="btn btn-outline-warning btn-sm" onclick="filterByCategory('å†å²')">ğŸ“œ å†å²</button>
        <button class="btn btn-outline-success btn-sm" onclick="filterByCategory('é‡‘è')">ğŸ’° é‡‘è</button>
        <button class="btn btn-outline-danger btn-sm" onclick="filterByCategory('è‹±è¯­')">ğŸ…°ï¸ è‹±è¯­</button>
        <button class="btn btn-outline-primary btn-sm" onclick="filterByCategory('æ•°å­¦')">ğŸ“ æ•°å­¦</button>
        <button class="btn btn-outline-dark btn-sm" onclick="filterByCategory('æ–‡å­¦')">ğŸ“– æ–‡å­¦</button>
      </div>
      <table class="table table-hover align-middle" id="bookTable">
        <thead class="table-light"><tr><th>ISBN</th><th>ä¹¦å</th><th>åˆ†ç±»</th><th>ä½œè€…</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card section-card border-reader">
    <div class="card-body">
      <h4 class="card-title mb-4 text-info"><i class="fas fa-user-plus section-icon"></i>è¯»è€…ç™»è®° (åŠè¯)</h4>
      <div class="row g-3">
        <div class="col-md-2"><input type="text" id="addReaderId" class="form-control" placeholder="å¡å·"></div>
        <div class="col-md-2"><input type="text" id="addReaderName" class="form-control" placeholder="å§“å"></div>
        <div class="col-md-2"><input type="text" id="addReaderPass" class="form-control" placeholder="å¯†ç  (é»˜è®¤123456)"></div>
        <div class="col-md-2"><select id="addReaderSex" class="form-select"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
        <div class="col-md-2"><input type="text" id="addReaderDeptId" class="form-control" placeholder="å•ä½"></div>
        <div class="col-md-2"><select id="addReaderType" class="form-select" onchange="updateLevelOptions()"><option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option><option value="æ•™å¸ˆ">æ•™å¸ˆ</option></select></div>
        <div class="col-md-2"><select id="addReaderLevel" class="form-select"></select></div>
        <div class="col-md-2"><button onclick="addReader()" class="btn btn-info text-white w-100">æ³¨å†Œ</button></div>
      </div>
      <span id="addReaderResult" class="result-msg"></span>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card section-card border-cancel h-100">
        <div class="card-body">
          <h4 class="card-title mb-3" style="color:#6f42c1"><i class="fas fa-user-slash section-icon"></i>è¯»è€…æ³¨é”€</h4>
          <div class="input-group">
            <input type="text" id="cancelCardId" class="form-control" placeholder="è¾“å…¥å¡å·">
            <button onclick="cancelReader()" class="btn btn-danger">æ³¨é”€</button>
          </div>
          <span id="cancelResult" class="result-msg"></span>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card section-card border-return h-100">
        <div class="card-body">
          <h4 class="card-title mb-3 text-danger"><i class="fas fa-undo section-icon"></i>è¿˜ä¹¦åŠç† (æŸœå°)</h4>
          <div class="input-group">
            <input type="text" id="returnIsbn" class="form-control" placeholder="è¾“å…¥å›¾ä¹¦ ISBN">
            <button onclick="returnBook()" class="btn btn-primary">ç¡®è®¤å½’è¿˜</button>
          </div>
          <span id="returnResult" class="result-msg"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="card section-card border-config mt-3">
    <div class="card-body">
      <h4 class="card-title mb-3 text-warning text-dark"><i class="fas fa-cogs section-icon"></i>ç³»ç»Ÿå‚æ•°è®¾ç½®</h4>
      <div class="row align-items-center">
        <div class="col-auto"><label>ç½šæ¬¾(å…ƒ/å¤©):</label></div>
        <div class="col-auto"><input type="number" id="configValue" class="form-control" placeholder="0.5"></div>
        <div class="col-auto"><button onclick="updateConfig()" class="btn btn-warning">ğŸ’¾ ä¿å­˜è®¾ç½®</button></div>
      </div>
      <span id="configResult" class="result-msg"></span>
    </div>
  </div>

</div>

<div class="modal fade" id="adminPassModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">ç®¡ç†å‘˜å¯†ç ä¿®æ”¹</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-3"><label>æ—§å¯†ç </label><input type="password" id="adminOldPass" class="form-control"></div>
        <div class="mb-3"><label>æ–°å¯†ç </label><input type="password" id="adminNewPass" class="form-control"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="changeAdminPassword()">ç¡®è®¤ä¿®æ”¹</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="bookDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title">å›¾ä¹¦è¯¦æƒ…ä¿¡æ¯</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3"><strong>ä¹¦å:</strong> <span id="detailTitle" class="fs-5"></span></div>
          <div class="col-md-6 mb-3"><strong>åˆ†ç±»:</strong> <span id="detailCategory" class="badge bg-info text-dark"></span></div>
          <div class="col-md-6 mb-3"><strong>ä½œè€…:</strong> <span id="detailAuthor"></span></div>
          <div class="col-md-6 mb-3"><strong>ISBN:</strong> <span id="detailIsbn"></span></div>
          <div class="col-md-6 mb-3"><strong>å‡ºç‰ˆç¤¾:</strong> <span id="detailPublisher"></span></div>
          <div class="col-md-6 mb-3"><strong>ä»·æ ¼:</strong> <span id="detailPrice" class="text-danger fw-bold"></span> å…ƒ</div>
          <div class="col-md-6 mb-3"><strong>çŠ¶æ€:</strong> <span id="detailStatus"></span></div>
        </div>
        <hr><h6 class="fw-bold">å†…å®¹æ‘˜è¦:</h6><div id="detailSummary" class="summary-box">æš‚æ— ç®€ä»‹...</div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  if (localStorage.getItem('role') !== 'admin') {
    alert("â›” éæ³•è®¿é—®ï¼è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·ã€‚"); window.location.href = 'login.html';
  }
  let currentBooksList = [];

  function logout() {
    if(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) { localStorage.clear(); window.location.href = 'login.html'; }
  }

  // --- 1. èè´­å®¡æ ¸é€»è¾‘ ---
  async function loadRecommends() {
    const res = await fetch('/api/recommend/list');
    const data = await res.json();
    const tbody = document.querySelector('#recTable tbody');
    tbody.innerHTML = '';
    if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— å¾…å®¡æ ¸è¯·æ±‚</td></tr>'; return; }

    data.forEach(item => {
      tbody.innerHTML += `<tr><td>${item.isbn}</td><td>${item.title}</td><td>${item.readerId}</td><td>${item.price}</td>
              <td><button class="btn btn-sm btn-success me-1" onclick="handleRec(${item.id}, true)">æ‰¹å‡†</button>
              <button class="btn btn-sm btn-danger" onclick="handleRec(${item.id}, false)">é©³å›</button></td></tr>`;
    });
  }

  async function handleRec(id, approved) {
    if(!confirm(approved ? "ç¡®å®šæ‰¹å‡†å¹¶è‡ªåŠ¨å…¥åº“å—ï¼Ÿ" : "ç¡®å®šé©³å›å—ï¼Ÿ")) return;
    const res = await fetch('/api/recommend/handle', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ id, approved })
    });
    const data = await res.json();
    alert(data.msg); loadRecommends(); loadBooks(); // æ‰¹å‡†ååˆ·æ–°å›¾ä¹¦åˆ—è¡¨
  }

  // --- 2. å›¾ä¹¦ç®¡ç†é€»è¾‘ ---
  async function apiCall(url, body, resultId) {
    const span = document.getElementById(resultId);
    span.innerText = "å¤„ç†ä¸­..."; span.className = "result-msg";
    try {
      const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
      const data = await res.json();
      if(data.success || !data.error) {
        span.innerText = "âœ… " + (data.msg || "æ“ä½œæˆåŠŸ"); span.className = "result-msg success";
        if(url.includes('/book')) loadBooks();
      } else {
        span.innerText = "âŒ " + (data.error || data.msg); span.className = "result-msg error";
      }
    } catch (e) { span.innerText = "âŒ ç½‘ç»œé”™è¯¯"; span.className = "result-msg error"; }
  }

  function addBook() {
    apiCall('/api/book', {
      isbn: document.getElementById('addBookIsbn').value,
      title: document.getElementById('addBookTitle').value,
      category: document.getElementById('addBookCategory').value,
      author: document.getElementById('addBookAuthor').value,
      price: document.getElementById('addBookPrice').value,
      publisher: document.getElementById('addBookPublisher').value,
      summary: document.getElementById('addBookSummary').value,
      status: "åœ¨åº“"
    }, 'addBookResult');
  }

  function filterByCategory(category) { document.getElementById('searchInput').value = category; searchBooks(); }
  async function searchBooks() { const k = document.getElementById('searchInput').value; renderBookTable(k ? `/api/books/search?keyword=${k}` : '/api/books'); }
  async function loadBooks() { document.getElementById('searchInput').value = ''; renderBookTable('/api/books'); }

  async function renderBookTable(url) {
    try {
      const res = await fetch(url); currentBooksList = await res.json();
      const tbody = document.querySelector('#bookTable tbody'); tbody.innerHTML = '';
      if(currentBooksList.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æœªæ‰¾åˆ°å›¾ä¹¦</td></tr>'; return; }
      currentBooksList.forEach(book => {
        const statusColor = book.status === 'åœ¨åº“' ? 'text-success' : 'text-danger';
        tbody.innerHTML += `<tr class="book-row" onclick="showBookDetail('${book.isbn}')"><td>${book.isbn}</td><td>${book.title}</td><td><span class="badge bg-secondary">${book.category||'å…¶ä»–'}</span></td><td>${book.author||'-'}</td><td class="${statusColor} fw-bold">${book.status}</td><td><button class="btn btn-sm btn-outline-primary">è¯¦æƒ…</button></td></tr>`;
      });
    } catch(e) {}
  }

  function showBookDetail(isbn) {
    const book = currentBooksList.find(b => b.isbn === isbn);
    if (!book) return;
    document.getElementById('detailTitle').innerText = book.title; document.getElementById('detailCategory').innerText = book.category;
    document.getElementById('detailAuthor').innerText = book.author; document.getElementById('detailIsbn').innerText = book.isbn;
    document.getElementById('detailPublisher').innerText = book.publisher; document.getElementById('detailPrice').innerText = book.price;
    document.getElementById('detailStatus').innerText = book.status; document.getElementById('detailSummary').innerText = book.summary || 'æš‚æ— ';
    new bootstrap.Modal(document.getElementById('bookDetailModal')).show();
  }

  // --- 3. è¯»è€…ä¸ç³»ç»Ÿé€»è¾‘ ---
  function addReader() {
    apiCall('/api/reader', {
      cardId: document.getElementById('addReaderId').value, name: document.getElementById('addReaderName').value,
      password: document.getElementById('addReaderPass').value, sex: document.getElementById('addReaderSex').value,
      deptId: document.getElementById('addReaderDeptId').value, type: document.getElementById('addReaderType').value,
      level: document.getElementById('addReaderLevel').value, isActive: true
    }, 'addReaderResult');
  }
  function cancelReader() { if(confirm("ç¡®å®šæ³¨é”€?")) apiCall('/api/reader/cancel', { cardId: document.getElementById('cancelCardId').value }, 'cancelResult'); }
  function returnBook() { apiCall('/api/return', { isbn: document.getElementById('returnIsbn').value }, 'returnResult'); }
  function updateConfig() { apiCall('/api/config/update', { key: 'overdue_fine_rate', value: document.getElementById('configValue').value }, 'configResult'); }

  async function changeAdminPassword() {
    const oldPass = document.getElementById('adminOldPass').value; const newPass = document.getElementById('adminNewPass').value;
    if (!oldPass || !newPass) return alert("è¯·å¡«å†™å®Œæ•´");
    const res = await fetch('/api/admin/password', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username: 'admin', oldPass, newPass }) });
    const data = await res.json(); alert(data.msg); if(data.success) logout();
  }

  function updateLevelOptions() {
    const type = document.getElementById('addReaderType').value; const levelSelect = document.getElementById('addReaderLevel');
    levelSelect.innerHTML = '';
    let options = type === 'å­¦ç”Ÿ' ? ['æœ¬ç§‘ç”Ÿ', 'ç ”ç©¶ç”Ÿ', 'åšå£«ç”Ÿ'] : ['å‰¯æ•™æˆ', 'æ­£æ•™æˆ', 'è®²å¸ˆ'];
    options.forEach(opt => levelSelect.add(new Option(opt, opt)));
  }
  updateLevelOptions();

  // åˆå§‹åŠ è½½
  loadRecommends();
  loadBooks();
</script>
</body>
</html>