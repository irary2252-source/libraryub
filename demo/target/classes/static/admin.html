<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†ç³»ç»Ÿ - å›¾ä¹¦é¦†</title>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #e9ecef; }
    h1 { text-align: center; color: #007bff; }
    .section { background: white; border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .form-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    label { font-weight: bold; width: 80px; text-align: right; }
    input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
    button { padding: 8px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .result-msg { margin-left: 10px; font-weight: bold; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>

<script>
  if (localStorage.getItem('role') !== 'admin') {
    alert("â›” éæ³•è®¿é—®ï¼è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·ã€‚");
    window.location.href = 'login.html'; // è·³è½¬å›ç™»å½•é¡µ
  }

  function logout() {
    if(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
      localStorage.clear();
      window.location.href = 'login.html';
    }
  }
</script>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <span style="font-weight: bold; color: #555;">å½“å‰ç”¨æˆ·: ç®¡ç†å‘˜</span>
  <button onclick="logout()" style="background-color: #6c757d;">ğŸšª é€€å‡ºç™»å½•</button>
</div>

<h1>ğŸ‘¨â€ğŸ’¼ å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ (ç®¡ç†å‘˜ç«¯)</h1>

<div class="section" style="border-left: 5px solid #28a745;">
  <h2>ğŸ“– å›¾ä¹¦ç™»è®° (å…¥åº“)</h2>
  <div class="form-group">
    <div><label>ä¹¦å·:</label> <input type="text" id="addBookIsbn" placeholder="ä¾‹å¦‚: 978-001"></div>
    <div><label>ä¹¦å:</label> <input type="text" id="addBookTitle" placeholder="ä¾‹å¦‚: æ•°æ®åº“åŸç†"></div>
    <div><label>ä½œè€…:</label> <input type="text" id="addBookAuthor"></div>
    <div><label>ä»·æ ¼:</label> <input type="number" id="addBookPrice"></div>
    <div><label>å‡ºç‰ˆç¤¾:</label> <input type="text" id="addBookPublisher"></div>
  </div>
  <button onclick="addBook()">â• æ·»åŠ å›¾ä¹¦</button>
  <span id="addBookResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #17a2b8;">
  <h2>ğŸ‘¤ è¯»è€…ç™»è®° (åŠè¯)</h2>
  <div class="form-group">
    <div><label>å¡å·:</label> <input type="text" id="addReaderId" placeholder="ä¾‹å¦‚: 2024001"></div>
    <div><label>å§“å:</label> <input type="text" id="addReaderName" placeholder="ä¾‹å¦‚: æå››"></div>
    <div>
      <label>å¯†ç :</label> <input type="text" id="addReaderPass" placeholder="ç•™ç©ºé»˜è®¤123456">
    </div>
    <div>
      <label>æ€§åˆ«:</label>
      <select id="addReaderSex"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
    </div>
    <div>
      <label>å•ä½:</label>
      <input type="text" id="addReaderDeptId" placeholder="ID æˆ– åç§°">
    </div>
    <div>
      <label>ç±»å‹:</label>
      <select id="addReaderType" onchange="updateLevelOptions()">
        <option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option><option value="æ•™å¸ˆ">æ•™å¸ˆ</option>
      </select>
    </div>
    <div>
      <label>çº§åˆ«:</label>
      <select id="addReaderLevel"></select>
    </div>
  </div>
  <button onclick="addReader()">ğŸ‘¤ æ³¨å†Œè¯»è€…</button>
  <span id="addReaderResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #6f42c1;">
  <h2>ğŸš« è¯»è€…æ³¨é”€ (æ’¤é”€)</h2>
  <div class="form-group">
    <div><label>å¡å·:</label> <input type="text" id="cancelCardId" placeholder="è¾“å…¥è¦æ³¨é”€çš„å¡å·"></div>
    <button onclick="cancelReader()" style="background-color: #dc3545;">â›” æ³¨é”€è¯»è€…</button>
  </div>
  <span id="cancelResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #dc3545;">
  <h2>ğŸ“¥ è¿˜ä¹¦åŠç† (å«ç½šæ¬¾)</h2>
  <div class="form-group">
    <div><label>å›¾ä¹¦ä¹¦å·:</label> <input type="text" id="returnIsbn" placeholder="è¾“å…¥å›¾ä¹¦ ISBN"></div>
    <button onclick="returnBook()">ç¡®è®¤å½’è¿˜</button>
  </div>
  <span id="returnResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #ffc107;">
  <h2>âš™ï¸ ç³»ç»Ÿå‚æ•°è®¾ç½®</h2>
  <div class="form-group">
    <div><label>å‚æ•°å:</label> <input type="text" id="configKey" value="overdue_fine_rate" readonly style="background:#eee;"></div>
    <div><label>ç½šæ¬¾/å¤©:</label> <input type="number" id="configValue" placeholder="0.5"></div>
    <button onclick="updateConfig()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
  </div>
  <span id="configResult" class="result-msg"></span>
</div>

<script>
  // åˆå§‹åŒ–çº§åˆ«ä¸‹æ‹‰æ¡†
  function updateLevelOptions() {
    const type = document.getElementById('addReaderType').value;
    const levelSelect = document.getElementById('addReaderLevel');
    levelSelect.innerHTML = '';
    let options = type === 'å­¦ç”Ÿ' ? ['æœ¬ç§‘ç”Ÿ', 'ç ”ç©¶ç”Ÿ', 'åšå£«ç”Ÿ'] : ['å‰¯æ•™æˆ', 'æ­£æ•™æˆ', 'è®²å¸ˆ'];
    options.forEach(opt => levelSelect.add(new Option(opt, opt)));
  }
  updateLevelOptions();

  // é€šç”¨ API è°ƒç”¨å‡½æ•°
  async function apiCall(url, body, resultId) {
    const span = document.getElementById(resultId);
    span.innerText = "å¤„ç†ä¸­..."; span.className = "result-msg";
    try {
      const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
      const contentType = res.headers.get("content-type");
      if (contentType && contentType.includes("application/json")) {
        const data = await res.json();
        if(data.success || !data.error) {
          span.innerText = "âœ… " + (data.msg || "æ“ä½œæˆåŠŸ"); span.className = "result-msg success";
        } else {
          span.innerText = "âŒ " + (data.error || data.msg); span.className = "result-msg error";
        }
      } else {
        const text = await res.text();
        span.innerText = text;
        span.className = text.includes("æˆåŠŸ") ? "result-msg success" : "result-msg error";
      }
    } catch (e) { span.innerText = "âŒ ç½‘ç»œé”™è¯¯"; span.className = "result-msg error"; }
  }

  // å„ç§æŒ‰é’®äº‹ä»¶
  function addBook() {
    apiCall('/api/book', {
      isbn: document.getElementById('addBookIsbn').value,
      title: document.getElementById('addBookTitle').value,
      author: document.getElementById('addBookAuthor').value,
      price: document.getElementById('addBookPrice').value,
      publisher: document.getElementById('addBookPublisher').value,
      status: "åœ¨åº“"
    }, 'addBookResult');
  }

  function addReader() {
    apiCall('/api/reader', {
      cardId: document.getElementById('addReaderId').value,
      name: document.getElementById('addReaderName').value,
      password: document.getElementById('addReaderPass').value, // ä¼ é€’å¯†ç 
      sex: document.getElementById('addReaderSex').value,
      deptId: document.getElementById('addReaderDeptId').value,
      type: document.getElementById('addReaderType').value,
      level: document.getElementById('addReaderLevel').value,
      isActive: true
    }, 'addReaderResult');
  }

  function cancelReader() {
    if(confirm("âš ï¸ ç¡®å®šè¦æ³¨é”€è¯¥è¯»è€…å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) {
      apiCall('/api/reader/cancel', { cardId: document.getElementById('cancelCardId').value }, 'cancelResult');
    }
  }

  function returnBook() {
    apiCall('/api/return', { isbn: document.getElementById('returnIsbn').value }, 'returnResult');
  }

  function updateConfig() {
    apiCall('/api/config/update', { key: 'overdue_fine_rate', value: document.getElementById('configValue').value }, 'configResult');
  }
</script>
</body>
</html>