<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; }
        h2 { margin-top: 0; font-size: 18px; color: #555; }

        /* æ¨¡å—å®¹å™¨æ ·å¼ */
        .section {
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* è¾“å…¥æ¡†å’Œæ ‡ç­¾æ ·å¼ */
        .form-group { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; font-weight: bold; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }

        /* æŒ‰é’®æ ·å¼ */
        button {
            padding: 8px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background-color: #0056b3; }

        /* ç»“æœæç¤ºä¿¡æ¯æ ·å¼ */
        .result-msg { margin-left: 10px; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }

        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; font-weight: bold; }
        tr:hover { background-color: #f1f1f1; }
    </style>
</head>
<body>

<h1>ğŸ“š å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ</h1>

<div class="section" style="border-left: 5px solid #28a745;">
    <h2>ğŸ“– å›¾ä¹¦ç™»è®° (å…¥åº“)</h2>
    <div class="form-group">
        <label>ISBN:</label> <input type="text" id="addBookIsbn" placeholder="ä¾‹å¦‚: 978-001">
        <label>ä¹¦å:</label> <input type="text" id="addBookTitle" placeholder="ä¾‹å¦‚: æ•°æ®åº“åŸç†">
    </div>
    <div class="form-group">
        <label>ä½œè€…:</label> <input type="text" id="addBookAuthor" placeholder="ä¾‹å¦‚: ç‹çŠ">
        <label>ä»·æ ¼:</label> <input type="number" id="addBookPrice" placeholder="ä¾‹å¦‚: 50.00">
    </div>
    <button onclick="addBook()">â• æ·»åŠ å›¾ä¹¦</button>
    <span id="addBookResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #17a2b8;">
    <h2>ğŸ‘¤ è¯»è€…ç™»è®° (åŠè¯)</h2>
    <div class="form-group">
        <label>è¯»è€…å¡å·:</label> <input type="text" id="addReaderId" placeholder="ä¾‹å¦‚: 2024001">
        <label>å§“å:</label> <input type="text" id="addReaderName" placeholder="ä¾‹å¦‚: æå››">
    </div>
    <div class="form-group">
        <label>çº§åˆ«(1-3):</label> <input type="number" id="addReaderLevel" value="1" placeholder="çº§åˆ«">
    </div>
    <button onclick="addReader()">ğŸ‘¤ æ³¨å†Œè¯»è€…</button>
    <span id="addReaderResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #ffc107;">
    <h2>ğŸ“¤ å€Ÿä¹¦åŠç†</h2>
    <div class="form-group">
        <label>å€Ÿä¹¦è¯å·:</label> <input type="text" id="borrowCardId" placeholder="è¾“å…¥è¯»è€…å¡å·">
        <label>å›¾ä¹¦ISBN:</label> <input type="text" id="borrowIsbn" placeholder="è¾“å…¥å›¾ä¹¦ISBN">
        <button onclick="borrowBook()" style="margin-left: 10px;">ç¡®è®¤å€Ÿé˜…</button>
    </div>
    <span id="borrowResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #dc3545;">
    <h2>ğŸ“¥ è¿˜ä¹¦åŠç†</h2>
    <div class="form-group">
        <label>å›¾ä¹¦ISBN:</label> <input type="text" id="returnIsbn" placeholder="è¾“å…¥å›¾ä¹¦ISBN">
        <button onclick="returnBook()" style="margin-left: 10px;">ç¡®è®¤å½’è¿˜</button>
    </div>
    <span id="returnResult" class="result-msg"></span>
</div>

<div class="section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>ğŸ“‹ é¦†è—å›¾ä¹¦åˆ—è¡¨</h2>
        <button onclick="loadBooks()" style="background-color: #6c757d; font-size: 12px;">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
    </div>
    <table id="bookTable">
        <thead>
        <tr>
            <th>ISBN</th>
            <th>ä¹¦å</th>
            <th>ä½œè€…</th>
            <th>ä»·æ ¼</th>
            <th>çŠ¶æ€</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
    // --- 1. æ·»åŠ å›¾ä¹¦åŠŸèƒ½ ---
    async function addBook() {
        const resultSpan = document.getElementById('addBookResult');
        resultSpan.innerText = "æ­£åœ¨æäº¤...";

        const book = {
            isbn: document.getElementById('addBookIsbn').value,
            title: document.getElementById('addBookTitle').value,
            author: document.getElementById('addBookAuthor').value,
            price: parseFloat(document.getElementById('addBookPrice').value),
            status: 0 // é»˜è®¤çŠ¶æ€ä¸ºåœ¨é¦†
        };

        // ç®€å•æ ¡éªŒ
        if(!book.isbn || !book.title) {
            resultSpan.innerText = "âŒ è¯·å¡«å†™å®Œæ•´çš„å›¾ä¹¦ä¿¡æ¯";
            resultSpan.className = "result-msg error";
            return;
        }

        try {
            const response = await fetch('/api/book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(book)
            });

            if(response.ok) {
                resultSpan.innerText = "âœ… å›¾ä¹¦å…¥åº“æˆåŠŸï¼";
                resultSpan.className = "result-msg success";
                loadBooks(); // æˆåŠŸååˆ·æ–°åˆ—è¡¨
                // æ¸…ç©ºè¾“å…¥æ¡†ä»¥ä¾¿ä¸‹æ¬¡è¾“å…¥
                document.getElementById('addBookIsbn').value = '';
                document.getElementById('addBookTitle').value = '';
            } else {
                resultSpan.innerText = "âŒ æ·»åŠ å¤±è´¥ï¼Œå¯èƒ½æ˜¯ISBNé‡å¤";
                resultSpan.className = "result-msg error";
            }
        } catch (e) {
            resultSpan.innerText = "âŒ ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸";
            resultSpan.className = "result-msg error";
        }
    }

    // --- 2. æ·»åŠ è¯»è€…åŠŸèƒ½ ---
    async function addReader() {
        const resultSpan = document.getElementById('addReaderResult');
        resultSpan.innerText = "æ­£åœ¨æäº¤...";

        const reader = {
            cardId: document.getElementById('addReaderId').value,
            name: document.getElementById('addReaderName').value,
            level: parseInt(document.getElementById('addReaderLevel').value),
            isActive: true
        };

        if(!reader.cardId || !reader.name) {
            resultSpan.innerText = "âŒ è¯·å¡«å†™å®Œæ•´çš„è¯»è€…ä¿¡æ¯";
            resultSpan.className = "result-msg error";
            return;
        }

        try {
            const response = await fetch('/api/reader', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reader)
            });

            if(response.ok) {
                resultSpan.innerText = "âœ… è¯»è€…æ³¨å†ŒæˆåŠŸï¼";
                resultSpan.className = "result-msg success";
                document.getElementById('addReaderId').value = '';
                document.getElementById('addReaderName').value = '';
            } else {
                resultSpan.innerText = "âŒ æ³¨å†Œå¤±è´¥ï¼Œå¡å·å¯èƒ½å·²å­˜åœ¨";
                resultSpan.className = "result-msg error";
            }
        } catch (e) {
            resultSpan.innerText = "âŒ ç½‘ç»œé”™è¯¯";
            resultSpan.className = "result-msg error";
        }
    }

    // --- 3. å€Ÿä¹¦åŠŸèƒ½ ---
    async function borrowBook() {
        const cardId = document.getElementById('borrowCardId').value;
        const isbn = document.getElementById('borrowIsbn').value;
        const resultSpan = document.getElementById('borrowResult');

        if(!cardId || !isbn) {
            resultSpan.innerText = "âš ï¸ è¯·è¾“å…¥å®Œæ•´çš„å¡å·å’ŒISBN";
            resultSpan.className = "result-msg error";
            return;
        }

        try {
            const response = await fetch('/api/borrow', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cardId, isbn })
            });
            const text = await response.text();
            resultSpan.innerText = text; // æ˜¾ç¤ºåç«¯è¿”å›çš„ä¿¡æ¯ï¼ˆæ¯”å¦‚"å€Ÿé˜…æˆåŠŸ"æˆ–"å€Ÿä¹¦ä¸Šé™"ï¼‰

            if(text.includes("æˆåŠŸ")) {
                resultSpan.className = "result-msg success";
                loadBooks(); // å€Ÿä¹¦æˆåŠŸååˆ·æ–°åˆ—è¡¨çŠ¶æ€
            } else {
                resultSpan.className = "result-msg error";
            }
        } catch (e) {
            resultSpan.innerText = "âŒ ç½‘ç»œé”™è¯¯";
        }
    }

    // --- 4. è¿˜ä¹¦åŠŸèƒ½ ---
    async function returnBook() {
        const isbn = document.getElementById('returnIsbn').value;
        const resultSpan = document.getElementById('returnResult');

        if(!isbn) {
            resultSpan.innerText = "âš ï¸ è¯·è¾“å…¥ISBN";
            resultSpan.className = "result-msg error";
            return;
        }

        try {
            const response = await fetch('/api/return', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ isbn })
            });
            const text = await response.text();
            resultSpan.innerText = text; // æ˜¾ç¤ºåç«¯è¿”å›çš„ä¿¡æ¯ï¼ˆæ¯”å¦‚"è¿˜ä¹¦æˆåŠŸ"æˆ–"éœ€ç¼´çº³ç½šæ¬¾"ï¼‰

            if(text.includes("æˆåŠŸ")) {
                resultSpan.className = "result-msg success";
                loadBooks(); // è¿˜ä¹¦æˆåŠŸååˆ·æ–°åˆ—è¡¨çŠ¶æ€
            } else {
                resultSpan.className = "result-msg error";
            }
        } catch (e) {
            resultSpan.innerText = "âŒ ç½‘ç»œé”™è¯¯";
        }
    }

    // --- 5. åŠ è½½å›¾ä¹¦åˆ—è¡¨åŠŸèƒ½ ---
    async function loadBooks() {
        try {
            const response = await fetch('/api/books');
            const books = await response.json();
            const tbody = document.querySelector('#bookTable tbody');
            tbody.innerHTML = '';

            books.forEach(book => {
                const tr = document.createElement('tr');
                // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²ï¼š0=åœ¨é¦†(ç»¿è‰²)ï¼Œ1=å€Ÿå‡º(çº¢è‰²)
                const statusText = book.status === 0 ? 'åœ¨é¦†' : 'å·²å€Ÿå‡º';
                const statusColor = book.status === 0 ? '#28a745' : '#dc3545';

                tr.innerHTML = `
                        <td>${book.isbn}</td>
                        <td>${book.title}</td>
                        <td>${book.author || '-'}</td>
                        <td>${book.price || '-'}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">
                            ${statusText}
                        </td>
                    `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            console.error("åŠ è½½åˆ—è¡¨å¤±è´¥", e);
        }
    }

    // é¡µé¢æ‰“å¼€æ—¶è‡ªåŠ¨åŠ è½½ä¸€æ¬¡åˆ—è¡¨
    loadBooks();
</script>
</body>
</html>