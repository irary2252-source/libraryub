<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; }
        h2 { margin-top: 0; font-size: 18px; color: #555; }
        .section { background: white; border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        label { font-weight: bold; width: 70px; text-align: right; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        textarea { width: 535px; height: 60px; resize: vertical; }
        button { padding: 8px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background-color: #0056b3; }
        .result-msg { margin-left: 10px; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; font-weight: bold; }
        tr:hover { background-color: #f1f1f1; }
    </style>
</head>
<body>

<h1>ğŸ“š å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ</h1>

<div class="section" style="border-left: 5px solid #28a745;">
    <h2>ğŸ“– å›¾ä¹¦ç™»è®° (å…¥åº“)</h2>
    <div class="form-group">
        <div><label>ä¹¦å·:</label> <input type="text" id="addBookIsbn" placeholder="ä¾‹å¦‚: 978-001"></div>
        <div><label>ä¹¦å:</label> <input type="text" id="addBookTitle" placeholder="ä¾‹å¦‚: æ•°æ®åº“åŸç†"></div>
    </div>
    <div class="form-group">
        <div><label>ä½œè€…:</label> <input type="text" id="addBookAuthor" placeholder="ä¾‹å¦‚: ç‹çŠ"></div>
        <div><label>ä»·æ ¼:</label> <input type="number" id="addBookPrice" placeholder="ä¾‹å¦‚: 50.00"></div>
    </div>
    <div class="form-group">
        <div><label>å‡ºç‰ˆç¤¾:</label> <input type="text" id="addBookPublisher" placeholder="ä¾‹å¦‚: é«˜ç­‰æ•™è‚²å‡ºç‰ˆç¤¾"></div>
    </div>
    <div class="form-group">
        <div><label>æ‘˜è¦:</label> <textarea id="addBookSummary" placeholder="è¯·è¾“å…¥å›¾ä¹¦æ‘˜è¦..."></textarea></div>
    </div>
    <button onclick="addBook()">â• æ·»åŠ å›¾ä¹¦</button>
    <span id="addBookResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #17a2b8;">
    <h2>ğŸ‘¤ è¯»è€…ç™»è®° (åŠè¯)</h2>
    <div class="form-group">
        <div><label>å¡å·:</label> <input type="text" id="addReaderId" placeholder="ä¾‹å¦‚: 2024001"></div>
        <div><label>å§“å:</label> <input type="text" id="addReaderName" placeholder="ä¾‹å¦‚: æå››"></div>
    </div>
    <div class="form-group">
        <div>
            <label>æ€§åˆ«:</label>
            <select id="addReaderSex">
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
            </select>
        </div>
        <div>
            <label>å•ä½:</label>
            <input type="text" id="addReaderDeptId" placeholder="è¾“å…¥ID(å¦‚1) æˆ– åç§°(å¦‚è®¡ç®—æœºå­¦é™¢)">
        </div>
    </div>
    <div class="form-group">
        <div>
            <label>ç±»å‹:</label>
            <select id="addReaderType" onchange="updateLevelOptions()">
                <option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option>
                <option value="æ•™å¸ˆ">æ•™å¸ˆ</option>
            </select>
        </div>
        <div>
            <label>çº§åˆ«:</label>
            <select id="addReaderLevel">
            </select>
        </div>
    </div>
    <button onclick="addReader()">ğŸ‘¤ æ³¨å†Œè¯»è€…</button>
    <span id="addReaderResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #ffc107;">
    <h2>ğŸ“¤ å€Ÿä¹¦åŠç†</h2>
    <div class="form-group">
        <div><label>å€Ÿä¹¦è¯:</label> <input type="text" id="borrowCardId" placeholder="è¾“å…¥è¯»è€…å¡å·"></div>
        <div><label>å›¾ä¹¦ä¹¦å·:</label> <input type="text" id="borrowIsbn" placeholder="è¾“å…¥å›¾ä¹¦ä¹¦å·"></div>
        <button onclick="borrowBook()" style="margin-left: 10px;">ç¡®è®¤å€Ÿé˜…</button>
    </div>
    <span id="borrowResult" class="result-msg"></span>
</div>

<div class="section" style="border-left: 5px solid #dc3545;">
    <h2>ğŸ“¥ è¿˜ä¹¦åŠç†</h2>
    <div class="form-group">
        <div><label>å›¾ä¹¦ä¹¦å·:</label> <input type="text" id="returnIsbn" placeholder="è¾“å…¥å›¾ä¹¦ä¹¦å·"></div>
        <button onclick="returnBook()" style="margin-left: 10px;">ç¡®è®¤å½’è¿˜</button>
    </div>
    <span id="returnResult" class="result-msg"></span>
</div>

<div class="section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>ğŸ“‹ é¦†è—å›¾ä¹¦åˆ—è¡¨</h2>
        <button onclick="loadBooks()" style="background-color: #6c757d; font-size: 12px;">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
    </div>
    <table id="bookTable">
        <thead>
        <tr><th>ä¹¦å·</th><th>ä¹¦å</th><th>ä½œè€…</th><th>å‡ºç‰ˆç¤¾</th><th>ä»·æ ¼</th><th>çŠ¶æ€</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // --- âœ… æ–°å¢ï¼šåŠ¨æ€æ›´æ–°çº§åˆ«ä¸‹æ‹‰æ¡†çš„é€»è¾‘ ---
    function updateLevelOptions() {
        const typeSelect = document.getElementById('addReaderType');
        const levelSelect = document.getElementById('addReaderLevel');
        const type = typeSelect.value;

        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        levelSelect.innerHTML = '';

        let options = [];
        if (type === 'å­¦ç”Ÿ') {
            options = ['æœ¬ç§‘ç”Ÿ', 'ç ”ç©¶ç”Ÿ'];
        } else if (type === 'æ•™å¸ˆ') {
            options = ['å‰¯æ•™æˆ', 'æ­£æ•™æˆ'];
        }

        // ç”Ÿæˆæ–°é€‰é¡¹
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.innerText = opt;
            levelSelect.appendChild(option);
        });
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸€æ¬¡
    updateLevelOptions();

    // --- 1. æ·»åŠ å›¾ä¹¦ ---
    async function addBook() {
        const resultSpan = document.getElementById('addBookResult');
        resultSpan.innerText = "æ­£åœ¨æäº¤...";
        const book = {
            isbn: document.getElementById('addBookIsbn').value,
            title: document.getElementById('addBookTitle').value,
            author: document.getElementById('addBookAuthor').value,
            price: parseFloat(document.getElementById('addBookPrice').value),
            publisher: document.getElementById('addBookPublisher').value,
            summary: document.getElementById('addBookSummary').value,
            status: "åœ¨åº“"
        };
        if(!book.isbn || !book.title) {
            resultSpan.innerText = "âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯"; resultSpan.className = "result-msg error"; return;
        }
        try {
            const response = await fetch('/api/book', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(book)
            });
            if(response.ok) {
                resultSpan.innerText = "âœ… å›¾ä¹¦å…¥åº“æˆåŠŸï¼"; resultSpan.className = "result-msg success";
                loadBooks();
            } else {
                resultSpan.innerText = "âŒ æ·»åŠ å¤±è´¥"; resultSpan.className = "result-msg error";
            }
        } catch (e) { resultSpan.innerText = "âŒ ç½‘ç»œé”™è¯¯"; resultSpan.className = "result-msg error"; }
    }

    // --- 2. æ·»åŠ è¯»è€… ---
    async function addReader() {
        const resultSpan = document.getElementById('addReaderResult');
        resultSpan.innerText = "æ­£åœ¨æäº¤...";

        const reader = {
            cardId: document.getElementById('addReaderId').value,
            name: document.getElementById('addReaderName').value,
            sex: document.getElementById('addReaderSex').value,
            deptId: document.getElementById('addReaderDeptId').value,
            type: document.getElementById('addReaderType').value,
            level: document.getElementById('addReaderLevel').value, // ç°åœ¨å–åˆ°çš„æ˜¯ä¸‹æ‹‰æ¡†çš„å€¼
            isActive: true
        };

        if(!reader.cardId || !reader.name || !reader.deptId) {
            resultSpan.innerText = "âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ (å«å•ä½)";
            resultSpan.className = "result-msg error";
            return;
        }

        try {
            const response = await fetch('/api/reader', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reader)
            });

            const data = await response.json();

            if (data.error) {
                resultSpan.innerText = "âŒ " + data.error;
                resultSpan.className = "result-msg error";
            } else {
                resultSpan.innerText = "âœ… è¯»è€…æ³¨å†ŒæˆåŠŸï¼";
                resultSpan.className = "result-msg success";
                document.getElementById('addReaderId').value = '';
            }
        } catch (e) {
            resultSpan.innerText = "âŒ ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸";
            resultSpan.className = "result-msg error";
        }
    }

    // --- 3. å€Ÿä¹¦ ---
    async function borrowBook() {
        const cardId = document.getElementById('borrowCardId').value;
        const isbn = document.getElementById('borrowIsbn').value;
        const resultSpan = document.getElementById('borrowResult');
        if(!cardId || !isbn) { resultSpan.innerText = "âš ï¸ è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯"; resultSpan.className = "result-msg error"; return; }
        try {
            const response = await fetch('/api/borrow', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cardId, isbn })
            });
            const text = await response.text();
            resultSpan.innerText = text;
            resultSpan.className = text.includes("æˆåŠŸ") ? "result-msg success" : "result-msg error";
            if(text.includes("æˆåŠŸ")) loadBooks();
        } catch (e) { resultSpan.innerText = "âŒ ç½‘ç»œé”™è¯¯"; }
    }

    // --- 4. è¿˜ä¹¦ ---
    async function returnBook() {
        const isbn = document.getElementById('returnIsbn').value;
        const resultSpan = document.getElementById('returnResult');
        if(!isbn) { resultSpan.innerText = "âš ï¸ è¯·è¾“å…¥ä¹¦å·"; resultSpan.className = "result-msg error"; return; }
        try {
            const response = await fetch('/api/return', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ isbn })
            });
            const text = await response.text();
            resultSpan.innerText = text;
            resultSpan.className = text.includes("æˆåŠŸ") ? "result-msg success" : "result-msg error";
            if(text.includes("æˆåŠŸ")) loadBooks();
        } catch (e) { resultSpan.innerText = "âŒ ç½‘ç»œé”™è¯¯"; }
    }

    function updateLevelOptions() {
        const typeSelect = document.getElementById('addReaderType');
        const levelSelect = document.getElementById('addReaderLevel');
        const type = typeSelect.value;

        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        levelSelect.innerHTML = '';

        let options = [];
        if (type === 'å­¦ç”Ÿ') {
            // âœ… ä¿®æ”¹ï¼šåœ¨è¿™é‡Œå¢åŠ äº† 'åšå£«ç”Ÿ'
            options = ['æœ¬ç§‘ç”Ÿ', 'ç ”ç©¶ç”Ÿ', 'åšå£«ç”Ÿ'];
        } else if (type === 'æ•™å¸ˆ') {
            options = ['å‰¯æ•™æˆ', 'æ­£æ•™æˆ', 'è®²å¸ˆ']; // ä¹Ÿå¯ä»¥é¡ºæ‰‹è¡¥ä¸ªè®²å¸ˆ
        }

        // ç”Ÿæˆæ–°é€‰é¡¹
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.innerText = opt;
            levelSelect.appendChild(option);
        });
    }

    // --- 5. åŠ è½½åˆ—è¡¨ ---
    async function loadBooks() {
        try {
            const response = await fetch('/api/books');
            const books = await response.json();
            const tbody = document.querySelector('#bookTable tbody');
            tbody.innerHTML = '';
            books.forEach(book => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${book.isbn}</td><td>${book.title}</td><td>${book.author||'-'}</td><td>${book.publisher||'-'}</td><td>${book.price||'-'}</td><td style="color:${book.status==='åœ¨åº“'?'#28a745':'#dc3545'}">${book.status}</td>`;
                tbody.appendChild(tr);
            });
        } catch (e) {}
    }
    loadBooks();
</script>
</body>
</html>